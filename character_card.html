<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Character Card</title>
<style>
  :root{--bg:#111;--panel:#1e1e1e;--border:#333;--text:#eee;--muted:#aaa;--accent:#3b82f6;}
  body{margin:0;background:var(--bg);color:var(--text);font-family:sans-serif;min-height:100vh;}
  #frame{max-width:1200px;margin:0 auto;padding:32px 16px;position:relative;}
  #logo{position:absolute;left:0;top:16px;width:140px;z-index:2;}
  #shell{margin-left:170px;border:2px solid var(--border);border-radius:10px;background:var(--panel);padding:24px;box-sizing:border-box;position:relative;}
  #level-box{position:absolute;top:16px;left:16px;background:#2a2a2a;border:1px solid var(--border);border-radius:6px;padding:8px 14px;text-align:center;min-width:120px;}
  #level-box .lvl{font-size:16px;font-weight:700;}
  #level-box .rank{font-size:12px;color:var(--muted);text-transform:capitalize;margin-top:2px;}
  header{text-align:center;margin-bottom:24px;}
  header h1{margin:0;font-size:32px;font-weight:700;}
  #grid{display:grid;grid-template-columns:360px 1fr;gap:24px;margin-top:24px;}
  #portrait-box{background:#222;border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;}
  #portrait{width:100%;height:420px;object-fit:cover;border-radius:6px;}
  #rank-wrap{text-align:center;margin-top:12px;}
  #rank-title{font-size:18px;font-weight:700;letter-spacing:.5px;}
  #rank-text{font-size:14px;color:var(--muted);text-transform:capitalize;}
  .panel{background:#222;border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:18px;}
  .panel h2{margin:0 0 12px;text-align:center;font-size:20px;}
  #xp-value{text-align:center;font-size:28px;font-weight:700;margin-bottom:12px;}
  .bar-wrap{background:#333;border:1px solid #555;border-radius:6px;height:20px;overflow:hidden;margin:8px 0;}
  .bar{height:100%;width:0;background:green;transition:width .3s;}
  .label{font-size:13px;color:var(--muted);text-align:center;}
  .icon-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));}
  .slot{aspect-ratio:1/1;background:#2f2f2f;border:1px dashed #555;border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:6px;}
  .slot img{max-width:80%;max-height:70%;object-fit:contain;}
  .slot .caption{margin-top:4px;font-size:12px;color:var(--muted);text-align:center;text-transform:capitalize;}
  .nav{position:fixed;top:50%;transform:translateY(-50%);font-size:34px;color:#999;background:#0006;padding:10px;border-radius:50%;cursor:pointer;user-select:none;}
  #prev{left:16px;} #next{right:16px;} .nav:hover{color:#fff;}
  #bottom-buttons{display:flex;justify-content:space-between;margin:24px 0 0;}
  .btn{padding:10px 18px;background:#2d2d2d;border:1px solid #333;border-radius:4px;color:var(--text);text-decoration:none;font-size:14px;}
  @media(max-width:980px){
    #logo{position:static;width:120px;margin:0 auto 12px;display:block;}
    #shell{margin:0;}
    #grid{grid-template-columns:1fr;}
    #portrait{height:320px;}
  }
  /* --- Bigger/taller badge slots only --- */
  #badges-grid .slot{
    aspect-ratio:auto;
    height:130px;
    padding:2px 2px 4px;
  }
  #badges-grid .slot img{ max-width:90%; max-height:85%; }
  #badges-grid .slot .caption{ margin-top:3px; font-size:12px; }
</style>
</head>
<body>
<div id="prev" class="nav">&#9664;</div>
<div id="next" class="nav">&#9654;</div>

<div id="frame">
  <img id="logo" src="assets/logo.png" alt="logo">
  <div id="shell">
    <div id="level-box">
      <div class="lvl">LEVEL <span id="lvl-num">1</span></div>
      <div class="rank" id="lvl-rank">Obrero</div>
    </div>

    <header><h1 id="name">Loadingâ€¦</h1></header>

    <div id="grid">
      <div id="portrait-box">
        <img id="portrait" src="" alt="portrait">
        <div id="rank-wrap">
          <div id="rank-title">RANK</div>
          <div id="rank-text">Obrero</div>
        </div>
      </div>

      <div>
        <div class="panel" id="stats-panel">
          <h2>STATS</h2>
          <div id="xp-value">0 XP</div>
          <div class="bar-wrap"><div id="health-bar" class="bar"></div></div>
          <div class="label" id="health-label"><b>Health: 0 / 100</b></div>
        </div>

        <div class="panel">
          <h2>INVENTORY</h2>
          <div id="inventory-grid" class="icon-grid"></div>
        </div>

        <div class="panel">
          <h2>BADGES</h2>
          <div id="badges-grid" class="icon-grid"></div>
        </div>
      </div>
    </div>

    <div id="bottom-buttons">
      <a id="store-btn" class="btn">Store</a>
      <a id="back-launch" class="btn" href="launch.html">Back to Launch</a>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SPREADSHEET_ID = '1VaO1MjgmnYKxgHkAlKxZQ1LLzgl0CAUVXTjgxUGDkRE';
const DEFAULT_CLASS  = 'Odell';
const SCRIPT_BASE='https://script.google.com/macros/s/AKfycbxjb514CMTbPtOJUEpmgANIXoYrTH8i9Qy3rIEao5zfE-SCTD4uuo5KfFbw2npYKJ1gIg/exec';
const ASSETS_BASE    = 'https://mugglee2.github.io/character-cards/assets';
const RANKS = ['Obrero','Explorador','Vaquero','Argonauta','PatrÃ³n','Terrateniente','Don','CapitÃ¡n','Mayordomo','Gobernador'];
const BADGE_TAB_PREFIX = 'Badges_'; // e.g. Badges_Odell

/* ===== URL PARAMS ===== */
const qs          = new URLSearchParams(location.search);
const className   = qs.get('class') || qs.get('sheet') || DEFAULT_CLASS;
const studentName = qs.get('student') || '';

/* ===== DATA HOLDERS ===== */
let headers=[], rows=[], idx=-1;
let badgeHeaders=[], badgeRows=[];

/* ===== HELPERS ===== */
async function fetchTab(tabName){
  const txt = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${encodeURIComponent(tabName)}&tqx=out:json`).then(r=>r.text());
  const json= JSON.parse(txt.substring(txt.indexOf('(')+1, txt.lastIndexOf(')')));
  const hdrs= json.table.cols.map(c=> (c.label||'').trim().toLowerCase());
  const rws = json.table.rows.map(r=> r.c.map(c=> c && c.v));
  return { hdrs, rows: rws };
}

/* ===== LOAD DATA ===== */
(async()=>{
  try{
    // main class tab
    const mainTxt = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${encodeURIComponent(className)}&tqx=out:json`).then(r=>r.text());
    const mainJson= JSON.parse(mainTxt.substring(mainTxt.indexOf('(')+1, mainTxt.lastIndexOf(')')));
    headers = mainJson.table.cols.map(c=> (c.label||'').trim().toLowerCase());
    rows    = mainJson.table.rows.map(r=> r.c.map(c=> c && c.v));
    const ni = headers.indexOf('studentname');
    idx = studentName ? rows.findIndex(r=> (r[ni]||'').toString().toLowerCase()===studentName.toLowerCase()) : 0;
    if(idx===-1) { alert('Student not found'); return; }

    // badge tab (optional)
    try{
      const badgeTab = `${BADGE_TAB_PREFIX}${className}`;
      const b = await fetchTab(badgeTab);
      badgeHeaders = b.hdrs;
      badgeRows    = b.rows;
    }catch(err){
      console.warn('Badge tab not found (optional):', err);
    }

    render();
  }catch(e){
    console.error(e);
    alert('Failed to load data');
  }
})();

/* ===== RENDER ===== */
function render(){
  const r = rows[idx];
  const val = k => r[headers.indexOf(k)] ?? '';

  const name      = val('studentname');
  const portrait  = val('portrait') || 'placeholder.png';
  const level     = +val('level')   || 1;
  const xp        = +val('xp')      || 0;
  const health    = +val('health')  || 0;
  const email     = (val('email') || '').toString();

  document.getElementById('name').textContent = name;
  document.getElementById('lvl-num').textContent = level;
  const rank = (RANKS[level-1]||'').toLowerCase();
  document.getElementById('lvl-rank').textContent = rank;
  document.getElementById('rank-text').textContent = rank;

  document.getElementById('portrait').src =
    portrait.startsWith('http') ? portrait : `${ASSETS_BASE}/${portrait.toLowerCase()}`;

  document.getElementById('xp-value').textContent = xp + ' XP';

  const hb  = document.getElementById('health-bar');
  const pct = Math.min(100, Math.max(0, health));
  hb.style.width = pct + '%';
  hb.style.background = pct>=80?'green':pct>=50?'dodgerblue':pct>=30?'gold':'red';
  document.getElementById('health-label').textContent = `Health: ${health} / 100`;

  // Inventory
  const invGrid = document.getElementById('inventory-grid');
  invGrid.innerHTML = '';
  const invFlags = headers.filter(h=>h.startsWith('has'));
  const owned    = invFlags.filter(f=> !!r[headers.indexOf(f)]);
  owned.forEach(flag=>{
    const key = flag.replace(/^has/i,'').toLowerCase();
    invGrid.appendChild(slot(`${ASSETS_BASE}/${key}.png`, key));
  });
  while(invGrid.children.length < 12) invGrid.appendChild(slot());

  // Badges (prefer separate tab)
  const badgeGrid = document.getElementById('badges-grid');
  badgeGrid.innerHTML = '';

  let groups = {};
  if(badgeHeaders.length){
    const bi = badgeHeaders.indexOf('studentname');
    const br = badgeRows.find(row=> (row[bi]||'').toString().toLowerCase()===name.toLowerCase());
    if(br){
      badgeHeaders.forEach((h,i)=>{
        if(!h.startsWith('badge')) return;
        const key = h.slice(5).split(':')[0].trim().toLowerCase();
        const score = Number(br[i]);
        if(!groups[key]) groups[key]=[];
        if(!isNaN(score)) groups[key].push(score);
      });
    }
  }else{
    // fallback to main tab
    headers.forEach((h,i)=>{
      if(!h.startsWith('badge')) return;
      const key = h.slice(5).split(':')[0].trim().toLowerCase();
      const score = Number(r[i]);
      if(!groups[key]) groups[key]=[];
      if(!isNaN(score)) groups[key].push(score);
    });
  }

  Object.entries(groups).forEach(([key,arr])=>{
    if(arr.length && arr.every(v=> v>=79)){
      badgeGrid.appendChild(slot(`${ASSETS_BASE}/${key}.png`, key));
    }
  });
  while(badgeGrid.children.length < 5) badgeGrid.appendChild(slot());

  // ðŸ”— Link to the new Store, prefilling email for faster login
  const storeURL = `${SCRIPT_BASE}?page=store${email ? `&email=${encodeURIComponent(email)}` : ''}`;
  document.getElementById('store-btn').href = storeURL;

  document.getElementById('back-launch').href =
    `launch.html?class=${encodeURIComponent(className)}`;
}

/* ===== UI HELPERS ===== */
function slot(img=null,label=''){
  const d=document.createElement('div'); d.className='slot';
  if(img){
    const im=document.createElement('img'); im.src=img; d.appendChild(im);
    if(label){
      const cap=document.createElement('div'); cap.className='caption'; cap.textContent=label;
      d.appendChild(cap);
    }
  }
  return d;
}

document.getElementById('prev').onclick = ()=>move(-1);
document.getElementById('next').onclick = ()=>move(1);
function move(delta){
  const n = headers.indexOf('studentname');
  idx = (idx + delta + rows.length) % rows.length;
  while(!rows[idx][n]) idx = (idx + delta + rows.length) % rows.length;
  const nextName = rows[idx][n];
  history.replaceState(null,'',`character_card.html?student=${encodeURIComponent(nextName)}&class=${encodeURIComponent(className)}`);
  render();
}
</script>
</body>
</html>
