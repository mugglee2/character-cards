<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Launch</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Page-specific tweaks */
    body {
      margin: 0;
      padding: 16px;
      position: relative;
      background: #121212 url("assets/background_launch.jpg") center / cover fixed no-repeat;
      color: #eee;
      font-family: sans-serif;
    }

    /* SETTINGS BUTTON */
    #settingsBtn {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 9999;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }
    #settingsBtn img {
      display: block;
      width: 34px;
      height: 34px;
      object-fit: contain;
    }

    #header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1200px;
      margin: 0 auto 16px;
    }
    #logo { height: 100px; }
    #classTitle {
      font-size: 28px;
      font-weight: 700;
      margin: 0;
      text-align: center;
      flex: 1;
    }
    #switchBtn {
      padding: 8px 14px;
      background: #2d2d2d;
      border: 1px solid #333;
      border-radius: 4px;
      color: #eee;
      cursor: pointer;
      font-size: 14px;
    }

    h2.section-label {
      margin: 24px auto 8px;
      max-width: 1200px;
      font-size: 22px;
      font-weight: 600;
    }

    #leaderGrid,
    #otherGrid {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      gap: 12px;
    }
    #leaderGrid { grid-template-columns: repeat(auto-fill, minmax(110px,1fr)); }
    #otherGrid  { grid-template-columns: repeat(auto-fill, minmax(110px,1fr)); }

    .tile {
      background: #444;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 8px;
      text-align: center;
      cursor: pointer;
      position: relative;
    }
    .tile img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
      display: block;
      margin: 0 auto 6px;
    }
    .tile-name      { font-size: 13px; margin-bottom: 4px; color: #fff; }
    .tile-points    { font-size: 12px; color: #aaa; }
    .rank-badge {
      position: absolute;
      top: 6px; left: 6px;
      background: #3b82f6;
      color: #fff;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
    }
  </style>
</head>
<body>

  <!-- Settings button pinned top-right -->
  <button id="settingsBtn">
    <img src="assets/settings.png" alt="Settings">
  </button>

  <div id="header-bar">
    <img id="logo" src="assets/logo.png" alt="logo">
    <h1 id="classTitle">Players</h1>
    <button id="switchBtn">Switch Classes</button>
  </div>

  <h2 class="section-label">Leaderboard (Top 10)</h2>
  <div id="leaderGrid">Loading…</div>

  <h2 class="section-label">Other players (ABC order)</h2>
  <div id="otherGrid"></div>

  <script>
    // CONFIG
    const SPREADSHEET_ID = '1VaO1MjgmnYKxgHkAlKxZQ1LLzgl0CAUVXTjgxUGDkRE';
    const DEFAULT_SHEET  = 'Odell';
    const ASSETS_BASE    = 'https://mugglee2.github.io/character-cards/assets';

    // State
    const params       = new URLSearchParams(location.search);
    let currentSheet   = params.get('sheet') || DEFAULT_SHEET;
    const classNames   = ['Odell','Aparicio'];

    // Utility: toggle class view
    function toggleClass(){
      const idx = classNames.indexOf(currentSheet);
      currentSheet = classNames[(idx+1) % classNames.length];
      const url = new URL(location.href);
      url.searchParams.set('sheet', currentSheet);
      location.href = url;
    }

    // Initialize header & switch
    document.getElementById('switchBtn').addEventListener('click', toggleClass);
    document.getElementById('classTitle').textContent = `${currentSheet} players`;

    // Fetch sheet data
    const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}`
              + `/gviz/tq?sheet=${encodeURIComponent(currentSheet)}&tqx=out:json`;

    fetch(url)
      .then(r => r.text())
      .then(txt => {
        const json    = JSON.parse(txt.slice(txt.indexOf('(') + 1, -2));
        const headers = json.table.cols.map(c=>c.label.trim().toLowerCase());
        const rows    = json.table.rows.map(r=>r.c.map(c=>c && c.v));

        const iName = headers.indexOf('studentname');
        const iPic  = headers.indexOf('portrait');
        const iXP   = headers.indexOf('xp');
        const iLvl  = headers.indexOf('level');

        const students = rows
          .filter(r => r[iName])
          .map(r => ({
            name: r[iName],
            pic:  r[iPic] && !String(r[iPic]).startsWith('http')
                  ? `assets/${r[iPic]}`
                  : (r[iPic] || `${ASSETS_BASE}/placeholder.png`),
            xp:   Number(r[iXP])  || 0,
            lvl:  Number(r[iLvl]) || 1
          }));

        // Top 10
        const sorted   = [...students].sort((a,b)=>b.xp - a.xp);
        const top10    = sorted.slice(0,10);
        const topNames = new Set(top10.map(s=>s.name));

        renderGrid(top10, document.getElementById('leaderGrid'), true);
        const others = students
          .filter(s=>!topNames.has(s.name))
          .sort((a,b)=>a.name.localeCompare(b.name));
        renderGrid(others, document.getElementById('otherGrid'), false);
      });

    // Render tiles
    function renderGrid(list, container, showPoints){
      container.innerHTML = '';
      list.forEach((s,idx) => {
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.innerHTML = `
          <img src="${s.pic}" alt="${s.name}">
          <div class="tile-name">${s.name}</div>
          ${showPoints ? `<div class="tile-points">${s.xp} XP</div>` : ''}
        `;
        if(showPoints){
          const badge = document.createElement('div');
          badge.className = 'rank-badge';
          badge.textContent = `#${idx+1}`;
          tile.appendChild(badge);
        }
        tile.addEventListener('click', ()=>{
          location.href = 
            `character_card.html?student=${encodeURIComponent(s.name)}` +
            `&sheet=${encodeURIComponent(currentSheet)}`;
        });
        container.appendChild(tile);
      });
    }

    // SETTINGS BTN handler: redirect to Apps Script portal
    document.getElementById('settingsBtn')
      .addEventListener('click', () => {
        const pw = prompt('Password?');
        if (pw === '8445') {
          window.location.href = 
            'https://script.google.com/macros/s/' +
            'AKfycbxjb514CMTbPtOJUEpmgANIXoYrTH8i9Qy3rIEao5zfE-' +
            'SCTD4uuo5KfFbw2npYKJ1gIg/exec?page=portal&class=Odell';
        }
      });
  </script>
</body>
</html>
